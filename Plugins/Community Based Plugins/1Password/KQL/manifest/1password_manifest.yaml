Descriptor:
  Name: 1Password
  DisplayName: 1Password (Community)
  Description: |-
    This integration enables Microsoft Copilot for Security to query and analyze 1Password audit and event logs using KQL (Kusto Query Language).  
    It allows security teams to monitor failed user login attempts and integration token changes within 1Password,  
    providing enhanced visibility and incident response capabilities directly from Microsoft Sentinel.
  Category: Other
  Icon: https://raw.githubusercontent.com/Azure/Azure-Sentinel/refs/heads/master/Logos/1password.svg
  Settings:

    - Name: TenantId
      Label: TenantId
      Description: Azure TenantId
      HintText: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
      SettingType: String
      Required: true

    - Name: SubscriptionId
      Label: Subscription Id
      Description: This is the subscription id that security copilot will use for sentinel.
      HintText: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
      SettingType: String
      Required: true

    - Name: ResourceGroupName
      Label: ResourceGroupName
      Description: This is the resource group name that security copilot will use for sentinel.
      HintText: rg-dev-sentinel
      SettingType: String
      Required: true

    - Name: WorkspaceName
      Label: WorkspaceName
      Description: This is the  workspace name that security copilot will use for sentinel.
      HintText: SentinelWorkspace
      SettingType: String
      Required: true

  SupportedAuthTypes:
    - None

SkillGroups:
  - Format: KQL
    Skills:

# -----------------------------------------------------------------------------------------------------------------------------
# base functionality - signinattempts (user and summarized)
# -----------------------------------------------------------------------------------------------------------------------------

      - Name: usersigninattempts
        DisplayName: user signin attempts
        Description: Fetches a summarized list of specific user signin attempts for the provided month (current_month/last_month)
        Inputs:
          - Name: month
            Description: Look back to the current_month or last_month.
            Required: true
          - Name: user
            Description: Filter for the user based on their UserPrincipalName (email).
            Required: true
        Settings:
          Target: Sentinel
          TenantId: '{{TenantId}}'
          SubscriptionId: '{{SubscriptionId}}'
          ResourceGroupName: '{{ResourceGroupName}}'
          WorkspaceName: '{{WorkspaceName}}'
          Template: |-
            let current_month = -0;
            let last_month = -1;
            OnePasswordEventLogs_CL
            // time filter
            | where TimeGenerated between (startofmonth(now(), {{month}}) .. endofmonth(now(), {{month}}))
            | where log_source == "signinattempts"
            // user filter
            | where tostring(target_user.email) == "{{user}}"
            // target_user variables
            | extend
                target_user_email = tostring(target_user.email)
                , target_user_name = tostring(target_user.name)
                , target_user_uuid = tostring(target_user.uuid)
            // client variables
            | extend
                client_app_name = tostring(client.app_name)
                , client_ip_address = tostring(client.ip_address)
                , client_os_name = tostring(client.os_name)
                , client_platform_name = tostring(client.platform_name)
            // location variables
            | extend
                location_city = tostring(location.city)
                , location_country = tostring(location.country)
                , location_region = tostring(location.region)
            | summarize by
                target_user_email
                , client_ip_address
                , target_user_name
                , target_user_uuid
                , category
                , action_type
                , client_app_name
                , client_os_name
                , client_platform_name
                , location_country
                , location_region
                , location_city
            | sort by
                target_user_email asc
                , client_ip_address asc

      - Name: summarizedsigninattempts
        DisplayName: summarized signin attempts
        Description: Fetches a summarized list of user signin attempts for the provided month (current_month/last_month)
        Inputs:
          - Name: month
            Description: Look back to the current_month or last_month.
            Required: true
        Settings:
          Target: Sentinel
          TenantId: '{{TenantId}}'
          SubscriptionId: '{{SubscriptionId}}'
          ResourceGroupName: '{{ResourceGroupName}}'
          WorkspaceName: '{{WorkspaceName}}'
          Template: |-
            let current_month = -0;
            let last_month = -1;
            OnePasswordEventLogs_CL
            // time filter
            | where TimeGenerated between (startofmonth(now(), {{month}}) .. endofmonth(now(), {{month}}))
            | where log_source == "signinattempts"
            // target_user variables
            | extend
                target_user_email = tostring(target_user.email)
                , target_user_name = tostring(target_user.name)
                , target_user_uuid = tostring(target_user.uuid)
            // client variables
            | extend
                client_app_name = tostring(client.app_name)
                , client_ip_address = tostring(client.ip_address)
                , client_os_name = tostring(client.os_name)
                , client_platform_name = tostring(client.platform_name)
            // location variables
            | extend
                location_city = tostring(location.city)
                , location_country = tostring(location.country)
                , location_region = tostring(location.region)
            | summarize by
                target_user_email
                , client_ip_address
                , target_user_name
                , target_user_uuid
                , category
                , action_type
                , client_app_name
                , client_os_name
                , client_platform_name
                , location_country
                , location_region
                , location_city
            | sort by
                target_user_email asc
                , client_ip_address asc

# -----------------------------------------------------------------------------------------------------------------------------
# base functionality - auditevents (user and summarized)
# -----------------------------------------------------------------------------------------------------------------------------

      - Name: userauditevents
        DisplayName: user audit events
        Description: Fetches a summarized list of specific user audit events for the provided month (current_month/last_month)
        Inputs:
          - Name: month
            Description: Look back to the current_month or last_month.
            Required: true
          - Name: user
            Description: Filter for the user based on their UserPrincipalName (email).
            Required: true
        Settings:
          Target: Sentinel
          TenantId: '{{TenantId}}'
          SubscriptionId: '{{SubscriptionId}}'
          ResourceGroupName: '{{ResourceGroupName}}'
          WorkspaceName: '{{WorkspaceName}}'
          Template: |-
            let current_month = -0;
            let last_month = -1;
            OnePasswordEventLogs_CL
            // time filter
            | where TimeGenerated between (startofmonth(now(), {{month}}) .. endofmonth(now(), {{month}}))
            // temporary addition of itemusages due to logging bug
            | where log_source == "auditevents" or (log_source == "itemusages" and action !in~ ("enter-item-edit-mode", "export", "fill", "other", "reveal", "secure-copy", "select-sso-provider", "server-create", "server-fetch", "server-update", "share"))
            // user filter
            | where tostring(actor_details.email) == "{{user}}"
            // location variables
            | extend
                location_country = tostring(location.country)
                , location_region = tostring(location.region)
                , location_city = tostring(location.city)
            // actor_details variables
            | extend
                actor_details_uuid = tostring(actor_details.uuid)
                , actor_details_name = tostring(actor_details.name)
                , actor_details_email = tostring(actor_details.email)
            // session variables
            | extend
                session_device_uuid = tostring(session.device_uuid)
                , session_ip_address = tostring(session.ip)
            | summarize by 
                actor_details_email
                , session_ip_address
                , actor_details_name
                , actor_details_uuid
                , action
                , object_type
                , aux_info
                , session_device_uuid
                , location_country
                , location_region
                , location_city
            | sort by
                actor_details_email asc
                , session_ip_address asc

      - Name: summarizedauditevents
        DisplayName: summarized audit events
        Description: Fetches a summarized list of user audit events for the provided month (current_month/last_month)
        Inputs:
          - Name: month
            Description: Look back to the current_month or last_month.
            Required: true
        Settings:
          Target: Sentinel
          TenantId: '{{TenantId}}'
          SubscriptionId: '{{SubscriptionId}}'
          ResourceGroupName: '{{ResourceGroupName}}'
          WorkspaceName: '{{WorkspaceName}}'
          Template: |-
            let current_month = -0;
            let last_month = -1;
            OnePasswordEventLogs_CL
            // time filter
            | where TimeGenerated between (startofmonth(now(), {{month}}) .. endofmonth(now(), {{month}}))
            // temporary addition of itemusages due to logging bug
            | where log_source == "auditevents" or (log_source == "itemusages" and action !in~ ("enter-item-edit-mode", "export", "fill", "other", "reveal", "secure-copy", "select-sso-provider", "server-create", "server-fetch", "server-update", "share"))
            // location variables
            | extend
                location_country = tostring(location.country)
                , location_region = tostring(location.region)
                , location_city = tostring(location.city)
            // actor_details variables
            | extend
                actor_details_uuid = tostring(actor_details.uuid)
                , actor_details_name = tostring(actor_details.name)
                , actor_details_email = tostring(actor_details.email)
            // session variables
            | extend
                session_device_uuid = tostring(session.device_uuid)
                , session_ip_address = tostring(session.ip)
            | summarize by 
                actor_details_email
                , session_ip_address
                , actor_details_name
                , actor_details_uuid
                , action
                , object_type
                , aux_info
                , session_device_uuid
                , location_country
                , location_region
                , location_city
            | sort by
                actor_details_email asc
                , session_ip_address asc

# -----------------------------------------------------------------------------------------------------------------------------
# base functionality - itemusages (user and summarized)
# -----------------------------------------------------------------------------------------------------------------------------

      - Name: useritemusages
        DisplayName: user item usages
        Description: Fetches a summarized list of specific user item usages for the provided month (current_month/last_month)
        Inputs:
          - Name: month
            Description: Look back to the current_month or last_month.
            Required: true
          - Name: user
            Description: Filter for the user based on their UserPrincipalName (email).
            Required: true
        Settings:
          Target: Sentinel
          TenantId: '{{TenantId}}'
          SubscriptionId: '{{SubscriptionId}}'
          ResourceGroupName: '{{ResourceGroupName}}'
          WorkspaceName: '{{WorkspaceName}}'
          Template: |-
            let current_month = -0;
            let last_month = -1;
            OnePasswordEventLogs_CL
            // time filter
            | where TimeGenerated between (startofmonth(now(), {{month}}) .. endofmonth(now(), {{month}}))
            // temporary addition of itemusages due to logging bug
            | where log_source == "itemusages" and action in~ ("enter-item-edit-mode", "export", "fill", "other", "reveal", "secure-copy", "select-sso-provider", "server-create", "server-fetch", "server-update", "share")
            // user filter
            | where tostring(user.email) == "{{user}}"
            // client variables
            | extend
                client_app_name = tostring(client.app_name)
                , client_platform_name = tostring(client.platform_name)
                , client_os_name = tostring(client.os_name)
                , client_ip_address = tostring(client.ip_address)
            // location variables
            | extend
                location_country = tostring(location.country)
                , location_region = tostring(location.region)
                , location_city = tostring(location.city)
            // user variables
            | extend
                user_uuid = tostring(user.uuid)
                , user_name = tostring(user.name)
                , user_email = tostring(user.email)
            | summarize by 
                user_email
                , client_ip_address
                , user_name
                , user_uuid
                , action
                , vault_uuid
                , item_uuid
                , location_country
                , location_region
                , location_city
            | sort by
                user_email asc
                , client_ip_address asc

      - Name: summarizeditemusages
        DisplayName: summarized item usages
        Description: Fetches a summarized list of user item usages for the provided month (current_month/last_month)
        Inputs:
          - Name: month
            Description: Look back to the current_month or last_month.
            Required: true
        Settings:
          Target: Sentinel
          TenantId: '{{TenantId}}'
          SubscriptionId: '{{SubscriptionId}}'
          ResourceGroupName: '{{ResourceGroupName}}'
          WorkspaceName: '{{WorkspaceName}}'
          Template: |-
            let current_month = -0;
            let last_month = -1;
            OnePasswordEventLogs_CL
            // time filter
            | where TimeGenerated between (startofmonth(now(), {{month}}) .. endofmonth(now(), {{month}}))
            // temporary addition of itemusages due to logging bug
            | where log_source == "itemusages" and action in~ ("enter-item-edit-mode", "export", "fill", "other", "reveal", "secure-copy", "select-sso-provider", "server-create", "server-fetch", "server-update", "share")
            // client variables
            | extend
                client_app_name = tostring(client.app_name)
                , client_platform_name = tostring(client.platform_name)
                , client_os_name = tostring(client.os_name)
                , client_ip_address = tostring(client.ip_address)
            // location variables
            | extend
                location_country = tostring(location.country)
                , location_region = tostring(location.region)
                , location_city = tostring(location.city)
            // user variables
            | extend
                user_uuid = tostring(user.uuid)
                , user_name = tostring(user.name)
                , user_email = tostring(user.email)
            | summarize by 
                user_email
                , client_ip_address
                , user_name
                , user_uuid
                , action
                , vault_uuid
                , item_uuid
                , location_country
                , location_region
                , location_city
            | sort by
                user_email asc
                , client_ip_address asc

# -----------------------------------------------------------------------------------------------------------------------------
# extra functionality - <insert log_source> (<insert query goal>)
# -----------------------------------------------------------------------------------------------------------------------------

      - Name: AnomalousUserSignin
        DisplayName: Anomalous User Sign-in
        Description: Fetches anomalous user sign-ins
        Inputs:
          - Name: month
            Description: Look back to the current_month or last_month.
            Required: true
        Settings:
          Target: Sentinel
          TenantId: '{{TenantId}}'
          SubscriptionId: '{{SubscriptionId}}'
          ResourceGroupName: '{{ResourceGroupName}}'
          WorkspaceName: '{{WorkspaceName}}'
          Template: |-


      - Name: AnomalousDeviceRegistration
        DisplayName: Anomalous Device Registration
        Description: Fetches anomalous device registrations
        Inputs:
          - Name: month
            Description: Look back to the current_month or last_month.
            Required: true
        Settings:
          Target: Sentinel
          TenantId: '{{TenantId}}'
          SubscriptionId: '{{SubscriptionId}}'
          ResourceGroupName: '{{ResourceGroupName}}'
          WorkspaceName: '{{WorkspaceName}}'
          Template: |-


      - Name: AnomalousDelegatedSessionCreation
        DisplayName: Anomalous Delegated Session Creation
        Description: Fetches anomalous delegated session creations
        Inputs:
          - Name: month
            Description: Look back to the current_month or last_month.
            Required: true
        Settings:
          Target: Sentinel
          TenantId: '{{TenantId}}'
          SubscriptionId: '{{SubscriptionId}}'
          ResourceGroupName: '{{ResourceGroupName}}'
          WorkspaceName: '{{WorkspaceName}}'
          Template: |-


      - Name: AnomalousVaultAccessGrant
        DisplayName: Anomalous Vault Access Grant
        Description: Fetches anomalous vault access granting
        Inputs:
          - Name: month
            Description: Look back to the current_month or last_month.
            Required: true
        Settings:
          Target: Sentinel
          TenantId: '{{TenantId}}'
          SubscriptionId: '{{SubscriptionId}}'
          ResourceGroupName: '{{ResourceGroupName}}'
          WorkspaceName: '{{WorkspaceName}}'
          Template: |-


      - Name: MassVaultItemViewing
        DisplayName: Mass Vault Item Viewing
        Description: Fetches mass vault item viewing activity
        Inputs:
          - Name: month
            Description: Look back to the current_month or last_month.
            Required: true
        Settings:
          Target: Sentinel
          TenantId: '{{TenantId}}'
          SubscriptionId: '{{SubscriptionId}}'
          ResourceGroupName: '{{ResourceGroupName}}'
          WorkspaceName: '{{WorkspaceName}}'
          Template: |-


      - Name: MassVaultItemViewing
        DisplayName: Mass Vault Item Viewing
        Description: Fetches mass vault item viewing activity
        Inputs:
          - Name: month
            Description: Look back to the current_month or last_month.
            Required: true
        Settings:
          Target: Sentinel
          TenantId: '{{TenantId}}'
          SubscriptionId: '{{SubscriptionId}}'
          ResourceGroupName: '{{ResourceGroupName}}'
          WorkspaceName: '{{WorkspaceName}}'
          Template: |-


      - Name: AnomalousGrouporUserModification
        DisplayName: Anomalous Group or user Modification
        Description: Fetches anomalous group or use modifcations
        Inputs:
          - Name: month
            Description: Look back to the current_month or last_month.
            Required: true
        Settings:
          Target: Sentinel
          TenantId: '{{TenantId}}'
          SubscriptionId: '{{SubscriptionId}}'
          ResourceGroupName: '{{ResourceGroupName}}'
          WorkspaceName: '{{WorkspaceName}}'
          Template: |-


      - Name: FailedSignInAttempts
        DisplayName: Failed sign-in events
        Description: Fetches failed sign-in events from 1Password
        Inputs:
          - Name: month
            Description: Look back to the current_month or last_month.
            Required: true
        Settings:
          Target: Sentinel
          TenantId: '{{TenantId}}'
          SubscriptionId: '{{SubscriptionId}}'
          ResourceGroupName: '{{ResourceGroupName}}'
          WorkspaceName: '{{WorkspaceName}}'
          Template: |-
            let current_month = -0;
            let last_month = -1;
            OnePasswordEventLogs_CL
            | where TimeGenerated between (startofmonth(now(), {{month}}) .. endofmonth(now(), {{month}}))
            | where log_source == "signinattempts"
            | where category != "success"
            | extend
                target_user_email = tostring(target_user.email)
                , target_user_name = tostring(target_user.name)
                , target_user_uuid = tostring(target_user.uuid)
                , client_app_name = tostring(client.app_name)
                , client_ip_address = tostring(client.ip_address)
                , client_os_name = tostring(client.os_name)
                , location_country = tostring(location.country)
                , location_region = tostring(location.region)
            | summarize
                arg_max(
                    TimeGenerated
                    , target_user_email
                    , target_user_name
                    , category
                    , action_type
                    , client_ip_address
                    , client_app_name
                    , client_os_name
                    , location_country
                    , location_region
                ) by
                    target_user_uuid
                    , session_uuid
            | project-reorder
                TimeGenerated
                , target_user_email
                , target_user_name
                , target_user_uuid
                , session_uuid
                , category
                , action_type
                , client_ip_address
                , client_app_name
                , client_os_name
                , location_country
                , location_region

      - Name: AnomalousActivity
        DisplayName: Anomalous activity after infrequent amount of sign-ins
        Description: Fetches anomalous activity after infrequent amount of sign-ins
        Inputs:
          - Name: month
            Description: Look back to the current_month or last_month.
            Required: true
        Settings:
          Target: Sentinel
          TenantId: '{{TenantId}}'
          SubscriptionId: '{{SubscriptionId}}'
          ResourceGroupName: '{{ResourceGroupName}}'
          WorkspaceName: '{{WorkspaceName}}'
          Template: |-
            let current_month = -0;
            let last_month = -1;
            let highRiskEventsTable = datatable(action:string, object_type:string, risk_level:string) [
                "activate", "account", "high"
                , "update", "account", "medium"
                , "delete", "account", "high"
                , "dlgsess", "dlgdsess", "high"
                , "create", "device", "high"
                , "update", "device", "medium"
                , "delete", "device", "high"
                , "updatfw", "account", "high"
                , "create", "group", "high"
                , "delete", "group", "high"
                , "join", "gm", "high"
                , "leave", "gm", "high"
                , "role", "gm", "high"
                , "grant", "gva", "high"
                , "revoke", "gva", "high"
                , "update", "gva", "high"
                , "create", "invite", "high"
                , "update", "invite", "medium"
                , "share", "item", "high"
                , "delshare", "item", "high"
                , "uisas", "account", "high"
                , "create", "mngdacc", "high"
                , "launchi", "mngdacc", "high"
                , "unlink", "mngdacc", "high"
                , "enblmfa", "user", "high"
                , "updatmfa", "user", "high"
                , "disblmfa", "user", "high"
                , "disblmfa", "account", "high"
                , "sendpkg", "user", "high"
                , "create", "sa", "high"
                , "create", "satoken", "high"
                , "trename", "satoken", "high"
                , "tverify", "satoken", "high"
                , "trevoke", "satoken", "high"
                , "ssotknv", "ssotkn", "high"
                , "disblsso", "sso", "high"
                , "chngpsso", "sso", "high"
                , "chngasso", "sso", "high"
                , "chngdsso", "sso", "high"
                , "addgsso", "sso", "high"
                , "delgsso", "sso", "high"
                , "verify", "user", "high"
                , "join", "user", "high"
                , "activate", "user", "high"
                , "suspend", "user", "high"
                , "delete", "user", "high"
                , "changemp", "user", "high"
                , "changesk", "user", "high"
                , "tdvcsso", "user", "high"
                , "sdvcsso", "user", "high"
                , "grant", "uva", "high"
                , "revoke", "uva", "high"
                , "update", "uva", "high"
                , "create", "vault", "high"
                , "delete", "vault", "high"
                , "update", "vault", "high"
                , "export", "vault", "high"
                , "vrfydmn", "account", "high"
                , "uvrfydmn", "account", "high"
                , "dvrfydmn", "account", "high"
            ];
            let signinBaselineEvents =
                OnePasswordEventLogs_CL
                | where TimeGenerated between (startofmonth(now(), {{month}}) .. endofmonth(now(), {{month}}))
                | where log_source == "signinattempts"
                | extend
                    target_user_email = tostring(target_user.email)
                    , target_user_uuid = tostring(target_user.uuid)
                    , client_ip_address = tostring(client.ip_address)
                | summarize count() by target_user_uuid, client_ip_address
                | extend targetIdentifier = base64_encode_tostring(strcat(target_user_uuid, client_ip_address))
                | where count_ > 5
                | summarize make_list(targetIdentifier)
            ;
            OnePasswordEventLogs_CL
            | where TimeGenerated between (startofmonth(now(), {{month}}) .. endofmonth(now(), {{month}}))
            | lookup kind=inner highRiskEventsTable on $left.action == $right.action and $left.object_type == $right.object_type
            | extend
                actor_ip = tostring(session.ip)
                , actor_details_email = tostring(actor_details.email)
            | extend targetIdentifier = base64_encode_tostring(strcat(actor_uuid, actor_ip))
            | where actor_details_email !endswith "1passwordserviceaccounts.com"
            | where targetIdentifier !in (signinBaselineEvents)